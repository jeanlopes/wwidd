/*! jorder - v0.1.7 - 2014-09-06 - Dan Stocker <dan@kwaia.com> - Copyright (c) 2010-2014 Dan Stocker*/
;var jorder={},j$=jorder,dessert=dessert||require("dessert"),troop=troop||require("troop"),sntls=sntls||require("sntls");troop.postpone(jorder,"IrregularNumber",function(){jorder.IrregularNumber=troop.Base.extend().addPrivateMethods({_getMaxValue:function(){var c=this.radices,a=1,b;for(b=0;b<c.length;b++){a*=c[b]}return a-1},_getRadixProducts:function(){var c=this.radices,d=1,a=[],b;for(b=c.length;--b;){a.unshift(d*=c[b])}return a},_convertToDigits:function(b){var d=this._radixProducts,a=[],c;for(c=0;c<d.length;c++){a.push(Math.floor(b/d[c]));b=b%d[c]}a.push(b);return a},_convertToScalar:function(e){var d=this._radixProducts,a=0,c,b;for(c=e.length,b=d.length;c--;b--){a+=e[c]*(d[b]||1)}return a}}).addMethods({init:function(a){dessert.isArray(a,"Invalid radices");this.radices=a;this._radixProducts=this._getRadixProducts();this.maxValue=this._getMaxValue();this.asScalar=0;this.asDigits=this._convertToDigits(0)},setScalar:function(a){dessert.assert(a<=this.maxValue,"Value out of bounds");this.asScalar=a;this.asDigits=this._convertToDigits(a);return this},setDigits:function(d){var c=this.radices,e,b,a;dessert.isArray(d,"Invalid digits").assert(d.length<=c.length,"Too many digits");e=this.asDigits;for(b=c.length,a=d.length-1;b--;a--){e[b]=d[a]||0}this.asScalar=this._convertToScalar(d);return this},inc:function(){var c=this.asDigits,b=this.radices,a;for(a=b.length-1;c[a]===b[a]-1;a--){c[a]=0}if(a>=0){c[a]++}this.asScalar++;return this}})});troop.postpone(jorder,"MultiArray",function(){var a=sntls.Hash;jorder.MultiArray=a.extend().addPrivateMethods({_getItemLengths:function(){var c=this.items,b=[],d;for(d=0;d<c.length;d++){b.push(c[d].length)}return b}}).addMethods({init:function(b){dessert.isArray(b,"Invalid items");a.init.apply(this,arguments)},selectCombination:function(e){dessert.isArray(e,"Invalid indices").assert(this.items.length===e.length,"Indices length doesn't match list length");var c=this.items,b=[],d;for(d=0;d<c.length;d++){b.push(c[d][e[d]])}return b},getCombinations:function(){var b=[],d=this._getItemLengths(),c;for(c=jorder.IrregularNumber.create(d);c.asScalar<=c.maxValue;c.inc()){b.push(this.selectCombination(c.asDigits))}return b},getCombinationsAsHash:function(){return sntls.Hash.create(this.getCombinations())}})});troop.amendPostponed(sntls,"Hash",function(){sntls.Hash.addMethods({toMultiArray:function(){return jorder.MultiArray.create(this.items)}})});troop.postpone(jorder,"RowSignature",function(){var a=Object.prototype.hasOwnProperty;jorder.RowSignature=troop.Base.extend().addConstants({FIELD_SEPARATOR_STRING:"|",FIELD_SEPARATOR_NUMBER:Math.pow(2,32),RE_WORD_DELIMITER:/\s+/,SIGNATURE_TYPE_SEPARATOR:"%",SIGNATURE_TYPES:{array:"array",fullText:"fullText",number:"number",string:"string"}}).addPrivateMethods({_createUniformArray:function(d,e){var b=new Array(d),c;for(c=0;c<d;c++){b[c]=e}return b},_uriEncoder:function(b){return this.isCaseInsensitive?encodeURI(b.toLowerCase()):encodeURI(b)},_arrayUriEncoder:function(e){var b=[],c,d;for(c=0;c<e.length;c++){d=e[c];if(typeof d==="string"){b.push(this.isCaseInsensitive?encodeURI(d.toLowerCase()):encodeURI(d))}else{b.push(String(d))}}return b}}).addMethods({init:function(e,b,c){dessert.isArray(e,"Invalid field names").assert(!!e.length,"Empty field name list").isStringOptional(b,"Invalid signature type").isBooleanOptional(c,"Invalid case flag");var d=this.SIGNATURE_TYPES;if(b){dessert.assert(d.hasOwnProperty(b),"Invalid signature type")}this.fieldNames=e;this.fieldNameLookup=sntls.StringDictionary.create({1:e}).reverse().items;this.signatureType=b||d.string;this.isCaseInsensitive=!!c;this.fieldSignature=[this._arrayUriEncoder(e).join(this.FIELD_SEPARATOR_STRING),this.signatureType].join(this.SIGNATURE_TYPE_SEPARATOR)},getKeyForRow:function(f){dessert.assert(this.containedByRow(f),"Row doesn't fit signature");var e=this.SIGNATURE_TYPES,d=this.fieldNames,b,c;switch(this.signatureType){case e.number:if(d.length===1){return f[d[0]]}else{b=this._createUniformArray(d.length,this.FIELD_SEPARATOR_NUMBER);c=sntls.Collection.create(f).filterByKeys(d).getValues();return jorder.IrregularNumber.create(b).setDigits(c).asScalar}break;case e.string:if(d.length===1){return this._uriEncoder(f[d[0]])}else{return sntls.StringCollection.create(f).filterByKeys(d).mapValues(this._uriEncoder,this).getValues().join(this.FIELD_SEPARATOR_STRING)}break;default:dessert.assert(false,"Invalid signature type");return""}},getKeysForRow:function(d){if(!d){return[]}var c=this.SIGNATURE_TYPES,b=this.fieldNames;switch(this.signatureType){case c.array:if(b.length===1){return this._arrayUriEncoder(d[b[0]])}else{return sntls.Collection.create(d).filterByKeys(b).getValuesAsHash().toMultiArray().getCombinationsAsHash().toCollection().mapValues(this._arrayUriEncoder,this,sntls.ArrayCollection).join(this.FIELD_SEPARATOR_STRING).getValues()}break;case c.fullText:if(b.length===1){return this._arrayUriEncoder(d[b[0]].split(this.RE_WORD_DELIMITER))}else{return sntls.StringCollection.create(d).filterByKeys(b).split(this.RE_WORD_DELIMITER).getValuesAsHash().toMultiArray().getCombinationsAsHash().toCollection().mapValues(this._arrayUriEncoder,this,sntls.ArrayCollection).join(this.FIELD_SEPARATOR_STRING).getValues()}break;default:case c.number:case c.string:return[this.getKeyForRow(d)]}},containedByRow:function(d){var c=this.fieldNames,b;for(b=0;b<c.length;b++){if(!a.call(d,c[b])){return false}}return true},containsRow:function(e){var b=this.fieldNameLookup,d=Object.keys(e),c;for(c=0;c<d.length;c++){if(!a.call(b,d[c])){return false}}return true}})});troop.postpone(jorder,"Index",function(){jorder.Index=troop.Base.extend().addPrivateMethods({_getUniqueRowIdsForKeys:function(a){return a.toStringDictionary().combineWith(this.rowIdLookup).getUniqueValues()}}).addMethods({init:function(c,a,b){this.rowSignature=jorder.RowSignature.create(c,a,b);this.rowIdLookup=sntls.StringDictionary.create();this.sortedKeys=sntls.OrderedStringList.create()},addRow:function(c,b){var a=this.rowSignature.getKeysForRow(c);this.rowIdLookup.addItems(a,b);this.sortedKeys.addItems(a);return this},removeRow:function(c,b){var a=this.rowSignature.getKeysForRow(c);this.rowIdLookup.removeItems(a,b);this.sortedKeys.removeItems(a);return this},clearBuffers:function(){this.rowIdLookup.clear();this.sortedKeys.clear();return this},getRowIdAt:function(a){return this.sortedKeys.items.slice(a,a+1).toStringDictionary().combineWith(this.rowIdLookup).getFirstValue()},getRowIdsBetweenAsHash:function(a,b){return this.sortedKeys.items.slice(a,b).toStringDictionary().combineWith(this.rowIdLookup)},getRowIdsBetween:function(a,b){return this.getRowIdsBetweenAsHash(a,b).items},getRowIdsForKeys:function(a){if(!(a instanceof Array)){a=[a]}return sntls.StringDictionary.create(a).combineWith(this.rowIdLookup).getUniqueValues()},getRowIdsForKeysAsHash:function(a){return sntls.Hash.create(this.getRowIdsForKeys(a))},getRowIdsForKeyRange:function(c,a,d,b){if(this.rowSignature.isCaseInsensitive){c=c.toLowerCase();a=a.toLowerCase()}return this.sortedKeys.getRangeAsHash(c,a,d,b).passSelfTo(this._getUniqueRowIdsForKeys,this)},getRowIdsForKeyRangeAsHash:function(c,a,d,b){return sntls.Hash.create(this.getRowIdsForKeyRange(c,a,d,b))},getRowIdsForPrefix:function(b,c,a){if(this.rowSignature.isCaseInsensitive){b=b.toLowerCase()}return this.sortedKeys.getRangeByPrefixAsHash(b,false,c,a).passSelfTo(this._getUniqueRowIdsForKeys,this)},getRowIdsForPrefixAsHash:function(b,c,a){return sntls.Hash.create(this.getRowIdsForPrefix(b,c,a))}})});(function(){dessert.addTypes({isIndex:function(a){return jorder.Index.isBaseOf(a)},isIndexOptional:function(a){return typeof a==="undefined"||jorder.Index.isBaseOf(a)}})}());troop.postpone(jorder,"IndexCollection",function(){var a=sntls.Collection;jorder.IndexCollection=sntls.Collection.of(jorder.Index).extend().addPrivateMethods({_isIndexContainedByRow:function(c,b){return b.rowSignature.containedByRow(c)},_indexFieldCountMapper:function(b){return b.rowSignature.fieldNames.length},_descNumericComparator:function(d,c){return d<c?1:d>c?-1:0}}).addMethods({setItem:function(b){dessert.isIndex(b,"Invalid index");a.setItem.call(this,b.rowSignature.fieldSignature,b);return this},getIndexesForRow:function(b){return this.filterBySelector(this._isIndexContainedByRow.bind(this,b))},getIndexForRow:function(b){return this.getIndexesForRow(b).getFirstValue()},getBestIndexForRow:function(b){return this.getIndexesForRow(b).mapKeys(this._indexFieldCountMapper).getSortedValues(this._descNumericComparator)[0]},getBestIndexForField:function(c){var b={};b[c]="";return this.getBestIndexForRow(b)},getIndexForFields:function(d,b){var c=jorder.RowSignature.create(d,b);return this.getItem(c.fieldSignature)}})});troop.postpone(jorder,"Table",function(){var b=sntls.Collection,a=b.extend();jorder.Table=a.addMethods({init:function(c){dessert.isArrayOptional(c,"Invalid table buffer");b.init.call(this,c||[]);this.indexCollection=jorder.IndexCollection.create()},setItem:function(c,d){this.indexCollection.removeRow(this.getItem(c),c).addRow(d,c);b.setItem.call(this,c,d);return this},setItems:function(d){var c=this;sntls.Collection.create(d).forEachItem(function(f,e){c.setItem(e,f)});return this},deleteItem:function(c){this.indexCollection.removeRow(this.getItem(c),c);b.deleteItem.call(this,c);return this},clone:function(){var c=b.clone.call(this);this.indexCollection.forEachItem(function(e){var d=e.rowSignature;c.addIndex(d.fieldNames,d.signatureType)});return c},addIndex:function(f,c,e){var d=jorder.Index.create(f,c,e);this.indexCollection.setItem(d);this.forEachItem(d.addRow,d);return this},reIndex:function(){var c=this.indexCollection;c.clearBuffers();this.forEachItem(c.addRow,c);return this},queryByRowIdsAsHash:function(c){return sntls.StringDictionary.create(c).combineWith(this.toDictionary())},queryByRowIds:function(c){return this.queryByRowIdsAsHash(c).items},queryByRowAsHash:function(d){var c=this.indexCollection.getBestIndexForRow(d);dessert.assert(!!c,"No index matches row");return c.getRowIdsForKeysAsHash(c.rowSignature.getKeysForRow(d)).toStringDictionary().combineWith(this.toDictionary())},queryByRow:function(c){return this.queryByRowAsHash(c).items},queryByRowsAsHash:function(d){dessert.isArray(d,"Invalid rows expression");var c=this.indexCollection.getBestIndexForRow(d[0]);dessert.assert(!!c,"No index matches row");return sntls.Collection.create(d).passEachItemTo(c.rowSignature.getKeysForRow,c.rowSignature).toStringDictionary().getUniqueValuesAsHash().toCollection().passEachItemTo(c.getRowIdsForKeys,c).toStringDictionary().getUniqueValuesAsHash().toStringDictionary().combineWith(this.toDictionary())},queryByRows:function(c){return this.queryByRowsAsHash(c).items},queryByOffsetAsHash:function(e,d){var c=this.indexCollection.getBestIndexForField(e);return c.getRowIdsBetweenAsHash(d,d+1).toStringDictionary().combineWith(this.toDictionary())},queryByOffset:function(d,c){return this.queryByOffsetAsHash(d,c).items},queryByOffsetRangeAsHash:function(f,c,e){var d=this.indexCollection.getBestIndexForField(f);return d.getRowIdsBetweenAsHash(c,e).toStringDictionary().combineWith(this.toDictionary())},queryByOffsetRange:function(e,c,d){return this.queryByOffsetRangeAsHash(e,c,d).items},queryByRangeAsHash:function(h,e,c,g,d){var f=this.indexCollection.getBestIndexForField(h);return f.getRowIdsForKeyRangeAsHash(e,c,g,d).toStringDictionary().combineWith(this.toDictionary())},queryByRange:function(g,e,c,f,d){return this.queryByRangeAsHash(g,e,c,f,d).items},queryByPrefixAsHash:function(g,e,f,c){var d=this.indexCollection.getBestIndexForField(g);dessert.assert(!!d,"No index matches row");return d.getRowIdsForPrefixAsHash(e,f,c).toStringDictionary().combineWith(this.toDictionary())},queryByPrefix:function(f,d,e,c){return this.queryByPrefixAsHash(f,d,e,c).items},insertRow:function(d){var c=this.items.push(d);this.indexCollection.getIndexesForRow(d).addRow(d,c-1+"");return this},insertRows:function(c){sntls.Collection.create(c).passEachItemTo(this.insertRow,this);return this},updateRowsByRow:function(d,e,c){dessert.isObject(d,"Invalid row expression").isObject(e,"Invalid row").isIndexOptional(c,"Invalid index");c=c||this.indexCollection.getBestIndexForRow(d);dessert.assert(!!c,"No index matches row");c.getRowIdsForKeysAsHash(c.rowSignature.getKeysForRow(d)).toCollection().passEachItemTo(this.setItem,this,0,e);return this},deleteRowsByRow:function(d,c){dessert.isObject(d,"Invalid row expression").isIndexOptional(c,"Invalid index");c=c||this.indexCollection.getBestIndexForRow(d);dessert.assert(!!c,"No index matches row");c.getRowIdsForKeysAsHash(c.rowSignature.getKeysForRow(d)).toCollection().forEachItem(b.deleteItem,this);return this},clear:function(){b.clear.call(this);this.indexCollection.clear();return this}});jorder.Table.addMethods({setRow:a.setItem,setRows:a.setItems,deleteRow:a.deleteItem})});troop.amendPostponed(sntls,"Hash",function(){sntls.Hash.addMethods({toTable:function(){return jorder.Table.create(this.items)}})});(function(){dessert.addTypes({isTable:function(a){return jorder.Table.isBaseOf(a)},isTableOptional:function(a){return typeof a==="undefined"||jorder.Table.isBaseOf(a)}})}());if(typeof module==="object"){module.exports=jorder};